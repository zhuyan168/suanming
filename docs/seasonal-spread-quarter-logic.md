# å››å­£ç‰Œé˜µæŒ‰å­£åº¦æŠ½ç‰Œé€»è¾‘è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å››å­£ç‰Œé˜µç°åœ¨æ”¯æŒæŒ‰å­£åº¦ç‹¬ç«‹æŠ½ç‰Œï¼Œæ¯ä¸ªç”¨æˆ·æ¯ä¸ªå­£åº¦åªèƒ½æŠ½ä¸€æ¬¡ï¼Œå†å²è®°å½•æŒ‰å­£åº¦ä¿å­˜ï¼Œç”¨æˆ·ä¹‹é—´å®Œå…¨éš”ç¦»ã€‚

---

## æ ¸å¿ƒæ”¹åŠ¨

### 1. å­£åº¦åˆ’åˆ†è§„åˆ™

```
æ˜¥å­£ï¼ˆQ2ï¼‰ï¼š3-5æœˆ
å¤å­£ï¼ˆQ3ï¼‰ï¼š6-8æœˆ  
ç§‹å­£ï¼ˆQ4ï¼‰ï¼š9-11æœˆ
å†¬å­£ï¼ˆQ1ï¼‰ï¼š12-2æœˆï¼ˆ12æœˆå½’åˆ°ä¸‹ä¸€å¹´Q1ï¼‰
```

å­£åº¦æ ‡è¯†æ ¼å¼ï¼š`2025-Q1`, `2025-Q2` ç­‰

---

## 2. ç”¨æˆ·éš”ç¦»æœºåˆ¶

### å‰ç«¯ç”Ÿæˆå”¯ä¸€sessionId

```typescript
// æ¯ä¸ªç”¨æˆ·é¦–æ¬¡è®¿é—®æ—¶ç”Ÿæˆå”¯ä¸€ID
const generateSessionId = (): string => {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 15);
  return `${timestamp}-${random}`;
};
```

- sessionIdä¿å­˜åœ¨localStorageï¼ˆ`user_session_id`ï¼‰
- æ¯æ¬¡è°ƒç”¨APIæ—¶ä¼ é€’æ­¤sessionId
- ä¸åŒç”¨æˆ·çš„sessionIdå®Œå…¨ç‹¬ç«‹

### åç«¯sessionéš”ç¦»

```javascript
// åç«¯ä½¿ç”¨Mapå­˜å‚¨ä¸åŒç”¨æˆ·çš„session
const sessionDrawnCards = new Map();
// key: sessionId, value: Set<å·²æŠ½ç‰ŒID>

// æŠ½æ»¡5å¼ åç«‹å³æ¸…ç†
if (drawnCardIds.size >= 5) {
  sessionDrawnCards.delete(currentSessionId);
}
```

---

## 3. æŒ‰å­£åº¦ä¿å­˜å†å²è®°å½•

### localStorageç»“æ„

```json
{
  "user_session_id": "1733472000000-abc123xyz",
  "seasonal_fortune_records": {
    "2024-Q4": {
      "quarter": "2024-Q4",
      "cards": [...],
      "reading": {...},
      "createdAt": 1733472000000
    },
    "2025-Q1": {
      "quarter": "2025-Q1",
      "cards": [...],
      "reading": {...},
      "createdAt": 1741248000000
    }
  }
}
```

### è¯»å–é€»è¾‘

```typescript
// 1. è·å–å½“å‰å­£åº¦
const currentQuarter = getCurrentQuarter(); // ä¾‹å¦‚ '2025-Q1'

// 2. è¯»å–æ‰€æœ‰å†å²è®°å½•
const allRecords = JSON.parse(localStorage.getItem('seasonal_fortune_records'));

// 3. æ£€æŸ¥å½“å‰å­£åº¦æ˜¯å¦å·²æŠ½è¿‡
const currentQuarterResult = allRecords[currentQuarter];
if (currentQuarterResult) {
  // å·²æŠ½è¿‡ï¼Œæ˜¾ç¤ºç»“æœ
} else {
  // æœªæŠ½è¿‡ï¼Œå…è®¸æŠ½ç‰Œ
}
```

### ä¿å­˜é€»è¾‘

```typescript
// æŠ½å®Œ5å¼ ç‰Œå
const result = {
  quarter: currentQuarter,
  cards: [...],
  reading: null,
  createdAt: Date.now()
};

// è¯»å–ç°æœ‰è®°å½•
const allRecords = JSON.parse(localStorage.getItem('seasonal_fortune_records')) || {};

// ä¿å­˜å½“å‰å­£åº¦
allRecords[currentQuarter] = result;
localStorage.setItem('seasonal_fortune_records', JSON.stringify(allRecords));
```

---

## 4. æŠ½ç‰Œæµç¨‹

### å•æ¬¡æŠ½ç‰Œè¿‡ç¨‹ï¼ˆ5å¼ ç‰Œï¼‰

1. **ç”¨æˆ·ç‚¹å‡»å¼€å§‹æŠ½ç‰Œ**
   - å‰ç«¯æ£€æŸ¥å½“å‰å­£åº¦æ˜¯å¦å·²æŠ½è¿‡
   - å¦‚æœå·²æŠ½è¿‡ â†’ æ˜¾ç¤ºç»“æœ
   - å¦‚æœæœªæŠ½è¿‡ â†’ åˆå§‹åŒ–ç‰Œå †

2. **æŠ½ç¬¬1-5å¼ ç‰Œ**
   - ç”¨æˆ·ç‚¹å‡»ä¸€å¼ ç‰Œ
   - è°ƒç”¨ `/api/seasonal-draw?slot=X&sessionId=xxx`
   - åç«¯ä»å¯¹åº”ç‰Œæ± éšæœºæŠ½å–
   - åç«¯è®°å½•å·²æŠ½ç‰ŒIDï¼ˆå»é‡ï¼ŒåŒä¸€sessionå†…ä¸é‡å¤ï¼‰
   - è¿”å›ç‰Œé¢ä¿¡æ¯

3. **æŠ½æ»¡5å¼ å**
   - å‰ç«¯ä¿å­˜åˆ°localStorageï¼ˆæŒ‰å­£åº¦ï¼‰
   - åç«¯ç«‹å³æ¸…ç†sessionï¼ˆåˆ é™¤Mapè®°å½•ï¼‰

4. **æŸ¥çœ‹ç»“æœ**
   - è°ƒç”¨ `/api/seasonal-reading` è·å–AIè§£è¯»
   - è§£è¯»ç»“æœä¿å­˜åˆ°å½“å‰å­£åº¦çš„è®°å½•ä¸­

---

## 5. é‡è¦ç‰¹æ€§

### âœ… ç”¨æˆ·éš”ç¦»
- æ¯ä¸ªç”¨æˆ·æœ‰å”¯ä¸€çš„sessionId
- ç”¨æˆ·Aå’Œç”¨æˆ·Bå¯ä»¥åŒæ—¶æŠ½ç‰Œ
- ä»–ä»¬å¯èƒ½æŠ½åˆ°å®Œå…¨ç›¸åŒçš„ç‰Œï¼ˆå…è®¸çš„ï¼‰
- äº’ä¸å½±å“ã€äº’ä¸å¹²æ‰°

### âœ… å­£åº¦é™åˆ¶
- æ¯ä¸ªç”¨æˆ·æ¯ä¸ªå­£åº¦åªèƒ½æŠ½ä¸€æ¬¡
- æœ¬å­£åº¦æŠ½å®Œåæ— æ³•é‡æ–°æŠ½
- ä¸‹ä¸ªå­£åº¦å¯ä»¥é‡æ–°æŠ½ç‰Œ

### âœ… å†å²è®°å½•
- ä¿ç•™æ‰€æœ‰å†å²å­£åº¦çš„è®°å½•
- å¯ä»¥æŸ¥çœ‹ä»»æ„å­£åº¦çš„ç»“æœ
- ä¾‹å¦‚ï¼š2024-Q4ã€2025-Q1ã€2025-Q2...

### âœ… ç‰Œå †ç‹¬ç«‹æ€§
- æ¯æ¬¡æŠ½ç‰Œï¼ˆæ–°å­£åº¦ï¼‰éƒ½æ˜¯å…¨æ–°çš„ç‰Œå †
- ç‰Œçš„é¡ºåºéšæœº
- ç‰Œçš„æ­£é€†ä½éšæœº
- åç«¯ä¸è®°å¿†ä¸Šæ¬¡æŠ½äº†ä»€ä¹ˆç‰Œ

### âœ… å•æ¬¡å»é‡
- 5å¼ ç‰Œå†…ä¸ä¼šé‡å¤ï¼ˆåŒä¸€ç‰Œæ± ä¸ä¼šæŠ½åˆ°ç›¸åŒç‰Œï¼‰
- æŠ½æ»¡5å¼ åï¼Œsessionç«‹å³æ¸…ç†
- ä¸‹æ¬¡æŠ½ç‰Œæ—¶æ˜¯å…¨æ–°çš„

---

## 6. æµ‹è¯•åœºæ™¯

### åœºæ™¯1ï¼šç”¨æˆ·é¦–æ¬¡æŠ½ç‰Œ
1. è®¿é—® `/fortune/seasonal`
2. localStorageä¸ºç©ºï¼Œæ˜¾ç¤ºæŠ½ç‰Œç•Œé¢
3. ç”ŸæˆsessionIdå¹¶ä¿å­˜
4. æŠ½å–5å¼ ç‰Œ
5. ä¿å­˜åˆ° `seasonal_fortune_records['2025-Q1']`

### åœºæ™¯2ï¼šç”¨æˆ·åˆ·æ–°é¡µé¢
1. è®¿é—® `/fortune/seasonal`
2. è¯»å–localStorage
3. å‘ç° `2025-Q1` å·²æœ‰è®°å½•
4. æ˜¾ç¤º"å·²æŠ½è¿‡"ï¼Œå±•ç¤ºç»“æœ

### åœºæ™¯3ï¼šæ–°å­£åº¦åˆ°æ¥
1. æ—¶é—´åˆ°äº†2025å¹´3æœˆï¼ˆæ˜¥å­£Q2ï¼‰
2. è®¿é—® `/fortune/seasonal`
3. æ£€æŸ¥ `seasonal_fortune_records['2025-Q2']`
4. æ²¡æœ‰è®°å½•ï¼Œå…è®¸é‡æ–°æŠ½ç‰Œ
5. æ—§è®°å½• `2025-Q1` ä»ä¿ç•™

### åœºæ™¯4ï¼šå¤šç”¨æˆ·åŒæ—¶åœ¨çº¿
1. ç”¨æˆ·Aï¼šsessionId = `123-abc`
2. ç”¨æˆ·Bï¼šsessionId = `456-xyz`
3. ç”¨æˆ·AæŠ½åˆ°æƒæ–Ace
4. ç”¨æˆ·Bä¹Ÿå¯èƒ½æŠ½åˆ°æƒæ–Aceï¼ˆä¸å†²çªï¼‰
5. åç«¯Mapï¼š
   ```javascript
   {
     '123-abc': Set[å¡ç‰Œ1, å¡ç‰Œ2, ...],
     '456-xyz': Set[å¡ç‰Œ3, å¡ç‰Œ4, ...]
   }
   ```

### åœºæ™¯5ï¼šåç«¯sessionæ¸…ç†
1. ç”¨æˆ·æŠ½æ»¡5å¼ ç‰Œ
2. åç«¯æ£€æµ‹åˆ° `drawnCardIds.size === 5`
3. ç«‹å³æ‰§è¡Œ `sessionDrawnCards.delete(sessionId)`
4. Mapä¸­çš„è®°å½•è¢«åˆ é™¤
5. ä¸‹æ¬¡ï¼ˆæ–°å­£åº¦ï¼‰æŠ½ç‰Œæ—¶ï¼Œç‰Œå †æ˜¯å…¨æ–°çš„

---

## 7. æ–‡ä»¶ä¿®æ”¹æ¸…å•

### å‰ç«¯æ–‡ä»¶

**pages/fortune/seasonal/index.tsx**
- âœ… æ·»åŠ å­£åº¦è®¡ç®—å‡½æ•° `getCurrentQuarter()`
- âœ… æ·»åŠ sessionIdç”Ÿæˆå’Œç®¡ç†å‡½æ•°
- âœ… ä¿®æ”¹localStorageä¸ºæŒ‰å­£åº¦ä¿å­˜
- âœ… è°ƒç”¨APIæ—¶ä¼ é€’sessionId
- âœ… æ·»åŠ  `SeasonalRecords` æ¥å£

**pages/fortune/seasonal/result.tsx**
- âœ… æ·»åŠ å­£åº¦è®¡ç®—å‡½æ•° `getCurrentQuarter()`
- âœ… ä¿®æ”¹localStorageè¯»å–é€»è¾‘ï¼ˆæŒ‰å­£åº¦ï¼‰
- âœ… ä¿®æ”¹readingä¿å­˜é€»è¾‘ï¼ˆæŒ‰å­£åº¦ï¼‰
- âœ… ä¿®æ”¹handleRedrawï¼ˆåˆ é™¤å½“å‰å­£åº¦è®°å½•ï¼‰

### åç«¯æ–‡ä»¶

**pages/api/seasonal-draw.js**
- âœ… æŠ½æ»¡5å¼ åæ¸…ç†session
- âœ… åˆ é™¤æ—§çš„å†å²è®°å½•ä¿å­˜é€»è¾‘ï¼ˆå·²ç§»åˆ°å‰ç«¯ï¼‰

---

## 8. æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·è®¿é—® /fortune/seasonal
    â†“
æ£€æŸ¥ localStorage
    â†“
è¯»å– seasonal_fortune_records
    â†“
è·å– currentQuarter (ä¾‹å¦‚ '2025-Q1')
    â†“
æ£€æŸ¥ records['2025-Q1'] æ˜¯å¦å­˜åœ¨ï¼Ÿ
    â†“
  æ˜¯ â†’ æ˜¾ç¤ºç»“æœé¡µé¢
    â†“
  å¦ â†’ æ˜¾ç¤ºæŠ½ç‰Œç•Œé¢
    â†“
ç”Ÿæˆ/è¯»å– sessionId
    â†“
ç”¨æˆ·ç‚¹å‡»æŠ½ç‰Œï¼ˆ5æ¬¡ï¼‰
    â†“
è°ƒç”¨ /api/seasonal-draw?sessionId=xxx&slot=1
    â†“
åç«¯ä»ç‰Œæ± æŠ½å–ï¼ˆå»é‡ï¼‰
    â†“
è¿”å›ç‰Œé¢ä¿¡æ¯
    â†“
æŠ½æ»¡5å¼ 
    â†“
å‰ç«¯ä¿å­˜åˆ° records['2025-Q1']
    â†“
åç«¯æ¸…ç† sessionDrawnCards[sessionId]
    â†“
è·³è½¬åˆ°ç»“æœé¡µé¢
    â†“
è°ƒç”¨ /api/seasonal-reading è·å–è§£è¯»
    â†“
ä¿å­˜readingåˆ° records['2025-Q1'].reading
```

---

## 9. æ³¨æ„äº‹é¡¹

### localStorageå®¹é‡
- æ¯ä¸ªå­£åº¦çš„è®°å½•çº¦ 5-10KB
- ä¿å­˜10ä¸ªå­£åº¦çº¦ 50-100KB
- å»ºè®®å®šæœŸæ¸…ç†è¶…è¿‡1å¹´çš„æ—§è®°å½•ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

### åç«¯å†…å­˜
- Mapä¼šåœ¨æœåŠ¡å™¨é‡å¯æ—¶æ¸…ç©ºï¼ˆæ­£å¸¸ï¼‰
- å»ºè®®æœªæ¥æ·»åŠ è¿‡æœŸæ¸…ç†æœºåˆ¶ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
- ä¾‹å¦‚ï¼š10åˆ†é’Ÿæ— æ´»åŠ¨çš„sessionè‡ªåŠ¨æ¸…ç†

### è·¨å­£åº¦è¾¹ç•Œ
- 12æœˆ31æ—¥ 23:59 â†’ å†¬å­£ï¼ˆä¸‹ä¸€å¹´Q1ï¼‰
- 1æœˆ1æ—¥ 00:00 â†’ å†¬å­£ï¼ˆå½“å‰å¹´Q1ï¼‰
- è¾¹ç•Œåˆ¤æ–­å·²å®ç°ï¼Œæ— éœ€æ‹…å¿ƒ

---

## 10. æœªæ¥ä¼˜åŒ–å»ºè®®

1. **åç«¯sessionè¿‡æœŸæœºåˆ¶**
   ```javascript
   // æ·»åŠ å®šæ—¶æ¸…ç†
   setInterval(() => {
     const now = Date.now();
     for (const [sessionId, data] of sessionDrawnCards.entries()) {
       if (now - data.lastActivity > 10 * 60 * 1000) { // 10åˆ†é’Ÿ
         sessionDrawnCards.delete(sessionId);
       }
     }
   }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
   ```

2. **å†å²è®°å½•æŸ¥çœ‹åŠŸèƒ½**
   - æ·»åŠ ä¸€ä¸ªé¡µé¢å±•ç¤ºæ‰€æœ‰å­£åº¦çš„è®°å½•
   - ç”¨æˆ·å¯ä»¥é€‰æ‹©æŸ¥çœ‹ä»»æ„å­£åº¦çš„ç»“æœ

3. **æ•°æ®è¿ç§»åˆ°æ•°æ®åº“**
   - å½“æ¥å…¥ç”¨æˆ·ç³»ç»Ÿå
   - å°†localStorageè¿ç§»åˆ°æ•°æ®åº“
   - æ”¯æŒè·¨è®¾å¤‡åŒæ­¥

---

## æ€»ç»“

âœ… æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„sessionId  
âœ… æ¯ä¸ªå­£åº¦åªèƒ½æŠ½ä¸€æ¬¡  
âœ… å†å²è®°å½•æŒ‰å­£åº¦ä¿å­˜  
âœ… ç”¨æˆ·ä¹‹é—´å®Œå…¨éš”ç¦»  
âœ… æ¯æ¬¡æŠ½ç‰Œéƒ½æ˜¯å…¨æ–°çš„ç‰Œå †  
âœ… å•æ¬¡æŠ½ç‰Œï¼ˆ5å¼ ï¼‰ä¸ä¼šé‡å¤  
âœ… åç«¯sessionè‡ªåŠ¨æ¸…ç†  

å®Œå…¨ç¬¦åˆä½ çš„éœ€æ±‚ï¼ğŸ‰

